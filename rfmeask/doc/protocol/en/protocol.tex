\documentclass{article}
\usepackage[left=40mm, top=30mm, right=30mm, bottom=30mm]{geometry}

\usepackage{multicol}
\usepackage{lipsum}
\usepackage{titlepic}
\usepackage{graphicx}
\usepackage{titling}
\usepackage{titlesec}

\usepackage[utf8x]{inputenc}
\usepackage[T2A]{fontenc}
\usepackage[english]{babel}

\usepackage{fancyvrb,newverbs,xcolor}
\usepackage{verbatimbox}
\usepackage{fancybox,fancyhdr}
\usepackage{lipsum}
\usepackage{listings}
\usepackage{lastpage}

\lstset{inputencoding=utf8x, extendedchars=\true}
\setlength{\parindent}{5ex}

\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{myblue}{rgb}{0,0.2,0.9}
\definecolor{mybrown}{rgb}{0.73,0.47,0.37}
\definecolor{mypurple}{rgb}{0.4,0.1,0.4}

\lstdefinestyle{python}{
  language=Python,
  showstringspaces=false,
  backgroundcolor=\color{white},   % choose the background color
  basicstyle=\small\ttfamily,        % size of fonts used for the code
  breaklines=true,                 % automatic line breaking only at whitespace
  captionpos=b,                    % sets the caption-position to bottom
  commentstyle=\color{mygreen},    % comment style
  escapeinside={\%*}{*)},          % if you want to add LaTeX within your code
  keywordstyle=\color{myblue},       % keyword style
  stringstyle=\color{mybrown},     % string literal style
  emph={True, False},
  emphstyle={\color{mypurple}},
}


\pagestyle{fancy} 

\fancyfoot[R]{\thepage/\pageref{LastPage}}
\fancyfoot[L]{rev. 3.2}
\fancyfoot[C]{}

\renewcommand{\footrulewidth}{0.3 mm} 
\renewcommand{\headrulewidth}{0.3 mm}

\titlespacing{\subsubsection}{8mm}{5mm}{0mm}

\newenvironment{gverb}
{\verbbox}
{\endverbbox\par\colorbox{lightgray}{\parbox{0.9\textwidth}{\theverbbox}}\par}

\setlength{\parskip}{0em}
\setlength{\parindent}{0mm}
\setlength{\leftskip}{8mm}

\begin{document}

\pretitle{
  \begin{center}
  \includegraphics[width=6cm,height=6cm]{smitek.jpg}\\[\bigskipamount]
}
\posttitle{\end{center}}

\date{May 26, 2020}
\title{\Large{Positioner's API Reference Manual}}
\author{Radioline}

\clearpage
\maketitle
\thispagestyle{empty}
\newpage

\tableofcontents
\newpage
\setlength{\parskip}{1em}

\section{Introduction}

This document describes the command system used for manual and automatic positioner control.

The main logical object of the protocol is logical axis. 
Logical axis represents one or more devices such as servo amplifier or syncronization module.
All commands are divided into axis commands, device commands and system commands.
Commands in this manual are sorted by functionality, their description, 
the specifics of application are noted. 
Usage examples are given where necessary.

Manual provides general description of control commands.
Depending on specific configuration, positioner type or functional 
purpose of its logical axes some commands are not implemented or are ignored.
Please check with the manufacturer for specific product type features.

\subsection{Protocol}
Positioner is controlled by the SCPI std V1999.0 4.2.1 protocol extended by a notification subscription system (NCPI).

SCPI protocol is used for parameters setup, devices status queries, move commands. 
There are three types of commands:
\begin{itemize}
  \item\textbf{:SYSTem:} -- system commands,
  \item\textbf{:AXIS\#:} -- logical axes functions,
  \item\textbf{:DEV\#:} -- hardware modules functions (serve amplifiers and other devices).
\end{itemize}

NCPI extension allows you to receive information about positioner state change in form of notifications.
The only type here is:
\begin{itemize}
  \item\textbf{:NOT:} - notification subscription.
\end{itemize}

Communication with positioner is carried out via TCP/IP through the rj45 (Ethernet) сonnector on the controller.
Two tcp ports are used:
\begin{itemize}
  \item SCPI console port 5025 (standard port for SCPI consoles),
  \item NCPI console port 5026.
\end{itemize}

When working with positioner via VISA library, socket mode is supported, instrument mode is not.

\newpage

\subsection{Namespacing}

\textbf{COMMAND\#} -- where '\#' is a natural number (beginning with 0). 

\textbf{<argument>} -- the argument of a command is in <> brackets.

\textbf{CMD:[SUBCMD]} -- the part in [ ] brackets is an unnescesarry argument or part of a command. 

There are also code blocks:
\begin{gverb}
*IDN?                       % Command query.
> RADIOLINE,XXX,XXX,XXX     % The answer is indicated by symbol '>'.
                            % - oneline commentary.
\end{gverb}

\subsection{On distance units}

There are several types of distance units used in protocol commands:

\begin{itemize}
  \item Revolution -- an engine revolution.
  \item Pulse -- servo drive feedback discrete. 
        There is a constant ratio of the number of pulses to the number of revolutions.
  \item Unit -- natural unit based on system requirements 
        (typically a centimeter for linear axes and a degree for axes of rotation).
\end{itemize}

\emph{* Pulse number per unit for the axis can be requested \\ by a command "AXIS\#:SETTINGS:RATIO?".}

\subsection{On acceleration units (acceleration time)}

Acceleration is a number of milliseconds required for engine to reach its nominal operating mode. 
Please note that when the acceleration time is reduced, the acceleration increases. 

\newpage
\section{Getting started}

SCPI protocol allows you to work in automatic and manual modes, depending on the source of commands.
For automatic mode the source of commands is the operating software.
For manual mode commands are entered by user via the I/O terminal.
These modes have no functional differences and both work through established TCP connection to the SCPI port (5025 by default) of the controller.

Manual mode can be used for connection check, for control commands debugging 
before using them in automatic mode, 
also for simple commands execution when operating software is unavailable.

Before you start working with the protocol, you should check the availability of the 
controller in local network and establish connection to the SCPI port of the positioner. 
To establish connection in manual mode you can use such utilities as \emph{PuTTY} (mode: \emph{raw}) or analogs.

SCPI protocol packet is an ASCII string, terminated by a symbol of line ending (LF: $\backslash$n, dec:10, bin:0x0A).

Test product ID query:
\begin{gverb}
*IDN?
> RADIOLINE,XXX,XXX,XXX
\end{gverb}

Status query:
\begin{gverb}
SYST:STAT?              % Positioner ready state query.
> 0                     % Positioner is ready for work.
\end{gverb}

Axis info query: 
\begin{gverb}
SYST:AXESTOT?           % Number of axes query.
> 3                     % There are three axes in the system: 0, 1, 2.
AXIS2:UPOSition?        % Indexes are zero-based.
> 0.378123              
\end{gverb}

Parameters setup:
\begin{gverb}
AXIS2:USPD 2            % Parameters setup and executional commands
                        % are not followed by the answer.        
\end{gverb}

\newpage
\input{scpi-section.tex}

\newpage
\input{ncpi-section.tex}

\newpage
\section{Examples}
\subsection{Example of script for product (python3)}

\begin{lstlisting}[style=python]
#!/usr/bin/env python3

import sys
import time
import socket
import threading

HOST = '192.168.1.224' # ip address
SCPI_PORT = 5025 
NCPI_PORT = 5026

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
n = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, SCPI_PORT))
n.connect((HOST, NCPI_PORT))

# request identifier
s.send("AXIS0:STAT:IDN?\r\n".encode("utf-8"))
answer = s.recv(1024).decode("utf-8")
print("axis0 idn is {}".format(answer))

# set speed : 1 unit per second
s.send("AXIS0:USPE 1\r\n".encode("utf-8"))

# set acceleration : 2 seconds for acceleration to nominal speed 
s.send("AXIS0:ACCEL 2000\r\n".encode("utf-8"))

# absolute move to coordinate 4u 
print("move to 4u")
s.send("AXIS0:UMOV:ABS 4\r\n".encode("utf-8"))

time.sleep(5)

# absolute move to coordinate 0u
print("move to 0u")
s.send("AXIS0:UMOV:ABS 0\r\n".encode("utf-8"))
\end{lstlisting}

\newpage
\subsection{Example of script for product using notification system (python3)}
\begin{lstlisting}[style=python]
#!/usr/bin/env python3

import sys
import time
import socket
import threading

HOST = '192.168.1.224' # ip address
SCPI_PORT = 5025
NCPI_PORT = 5026

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
n = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, SCPI_PORT))
n.connect((HOST, NCPI_PORT))

s.send("AXIS0:STAT:IDN?\r\n".encode("utf-8"))
answer = s.recv(1024).decode("utf-8")
print("axis0 idn is {}".format(answer))

print("enable notification")
n.send("NOT:AXIS0:UPOS SMOOTH, 0.1\r\n".encode("utf-8"))
n.send("NOT:AXIS0:OPSTAT 1\r\n".encode("utf-8"))

cancel = False
def foo():
  n.settimeout(0.5)
  while cancel is False:
    try:
      message = n.recv(1024).decode("utf-8")
    except:
      pass
    sys.stdout.write("notification: {}".format(message))

thr = threading.Thread(target=foo)
thr.start()

print("move to 4u")
s.send("AXIS0:UMOV:ABS 4\r\n".encode("utf-8"))

time.sleep(5)

print("move to 0u")
s.send("AXIS0:UMOV:ABS 0\r\n".encode("utf-8"))

time.sleep(5)
cancel = True
\end{lstlisting}
 
\newpage
\subsection{Example of script for product, scanning scenario (python3)}
\begin{lstlisting}[style=python]
#!/usr/bin/env python3
​
import sys
import time
import socket
import threading
​
HOST = '192.168.1.224' # ip address
SCPI_PORT = 5025 
NCPI_PORT = 5026
​
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
n = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, SCPI_PORT))
n.connect((HOST, NCPI_PORT))
​
print("enable notifications")
n.send("NOT:AXIS0:OPSTAT 1\r\n".encode("utf-8"))
n.send("NOT:AXIS0:SCAN:POINT\r\n".encode("utf-8")) 
​
cancel = False
def foo():
  n.settimeout(0.5)
  while cancel is False:
    try:
      message = n.recv(1024).decode("utf-8")
    except:
      pass
    sys.stdout.write("notification: {}".format(message))

thr = threading.Thread(target=foo)
thr.start()

print("set scan points number to 10")
s.send("AXIS0:SCAN:POINTS 10\r\n".encode("utf-8"))
​
print("set scan distance to 10u")
s.send("AXIS0:SCAN:UMOVE 10\r\n".encode("utf-8"))
​
print("activate scanning mode")
s.send("AXIS0:SCAN:COMPSTART\r\n".encode("utf-8"))
​
print("move on 10u")
s.send("AXIS0:UMOV 10\r\n".encode("utf-8"))
# while moving, notifications on points passed are sent to NCPI_PORT 
​
time.sleep(5)
cancel = True
\end{lstlisting}

\newpage
\subsection{Example of script for product, manual trigger (python3)}
\begin{lstlisting}[style=python]
#!/usr/bin/env python3
​
import sys
import time
import socket
import threading
​
HOST = '192.168.1.224' # ip address
SCPI_PORT = 5025 
​
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, SCPI_PORT))

# Manual trigger mode is used to generate trigger manually 
# using AXIS:TRIGGER command. It can be usefull
# when debugging connection with measuring device.
​
print("set manual trigger mode")
s.send("AXIS0:MANTRIG 1\r\n".encode("utf-8"))
​
print("send trigger")
s.send("AXIS0:TRIGGER\r\n".encode("utf-8"))
​
# waiting
time.sleep(1)

# TRIGRETTIME requests time passed between
# trigger generated and reverse trigger recieved.
# It is usefull for scanning setup.
​
s.send("AXIS0:TRIGRETTIME?\r\n".encode("utf-8"))
answer = s.recv(1024).decode("utf-8")
print("time passed: {}".format(answer))

\end{lstlisting}

\newpage
\section{Typical problems}
\subsubsection*{Connection is not established}
Make sure that the control unit is avalible in local network. 
Check the hardware connection. 
Ping the positioner.
Make sure that the firewall on your PC does not block the connection.
Restart the control unit if needed.

\subsubsection*{Product does not react on control commands}
Check the format and text of command. Make sure that the command is terminated with line end symbol LF.

\subsubsection*{Product answers the commands, but does not move}
Check the SCPI error stack.
Check system and axes status using commands:
\setlength{\parskip}{1em}

\begin{gverb}
SYST:STAT?
AXIS\#:STAT?          
\end{gverb}

Please contact the manufacturer in case of errors.
\setlength{\parskip}{0em}

\subsubsection*{Axis moves in the same direction regardless of the given direction of movement.}
Check UNSAFE movement commands.
Make sure the axis limits are set correctly and that the current position is not down.
Reconfigure zero and limits if needed.

\subsubsection*{No notifications comes in continious scanning mode}
Make sure the axis supports continious scanning mode
Check that the trigger circuits are installed correctly. 
Check that scan setting are set correctly.

\end{document}

