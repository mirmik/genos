\documentclass{article}
\usepackage[left=40mm, top=30mm, right=30mm, bottom=30mm]{geometry}

\usepackage{multicol}
\usepackage{lipsum}
\usepackage{titlepic}
\usepackage{graphicx}
\usepackage{titling}
\usepackage{titlesec}

\usepackage[utf8x]{inputenc}
\usepackage[T2A]{fontenc}
\usepackage[english, russian]{babel}

\usepackage{fancyvrb,newverbs,xcolor}
\usepackage{verbatimbox}
\usepackage{fancybox,fancyhdr}
\usepackage{lipsum}
\usepackage{listings}
\lstset{inputencoding=utf8x, extendedchars=\true}
\setlength{\parindent}{5ex}

\usepackage{lastpage} 
\pagestyle{fancy} 

\fancyfoot[R]{\thepage/\pageref{LastPage}}
\fancyfoot[L]{рев. 3.1}
\fancyfoot[C]{}

\renewcommand{\footrulewidth}{0.3 mm} 
\renewcommand{\headrulewidth}{0.3 mm}

\titlespacing{\subsubsection}{8mm}{5mm}{0mm}

\newenvironment{gverb}
{\verbbox}
{\endverbbox\par\colorbox{lightgray}{\parbox{0.9\textwidth}{\theverbbox}}\par}

\setlength{\parskip}{0em}
\setlength{\parindent}{0mm}
\setlength{\leftskip}{8mm}

\begin{document}

\pretitle{
  \begin{center}
  \includegraphics[width=6cm,height=6cm]{en/smitek.jpg}\\[\bigskipamount]
}
\posttitle{\end{center}}

\date{18 сентября 2020}
\title{\Large{Справочное руководство по SCPI протоколу управления позиционеров серий PS.}}
\author{Radioline}

\clearpage
\maketitle
\thispagestyle{empty}
\newpage

\tableofcontents
\newpage
\setlength{\parskip}{1em}

\section{Общая информация.}
Настоящий документ описывает систему команд управления для реализации автоматического или ручного управления позиционером. 

Основной функциональной единицей протокола является логическая ось изделия. Логическая ось образуется одним или более входящих в нее устройств, таких как сервоусилитель или модуль синхронизации. 
Команды делятся на команды осей, образующих их устройств и системные команды. Команды в руководстве отсортрованы по функциональному назначению и даны с описанием аргументов и особенностей применения. В необходимых местах приводятся примеры использования. 

В документе представлена общая справка по командам управления. Для конкретных конфигураций, типов оборудования, а также, в зависимости от функционального назначения логических осей изделия, часть команд может быть не реализована или игнорироваться. Особенности работы с конкретным типом изделия уточняйте у изготовителя.

\subsection{Протокол.}
Управление изделием осуществляется по протоколу SCPI std V1999.0 4.2.1, расширенному системой подписки на уведомления NCPI. 

Протокол SCPI используется для выставления параметров, запросов состояния прибора, передачи комманд.
Функциональные подсистемы:
\begin{itemize}
\item\textbf{:SYSTem:} - общесистемные комманды.
\item\textbf{:AXIS\#:} - функции логических осей.
\item\textbf{:DEV\#:} - функции аппаратных модулей (сервоусилителей и прочих приборов)
\end{itemize}

Расширение NCPI позволяет получать информацию об изменении состояния изделия в режиме уведомлений.
Используется единственная функциональная подсистема:
\begin{itemize}
\item\textbf{:NOT:} - подписка на уведомления 
\end{itemize}

Связь с изделием осуществляется по протоколу TCP/IP через разъём rj45 (ethernet) на корпусе контроллера. 
Система использует два tcp порта:
\begin{itemize}
\itemПорт SCPI консоли 5025 (стандартный порт для SCPI-консолей).
\itemПорт NCPI консоли 5026.
\end{itemize}

При работе с прибором через библиотеку VISA поддерживается режим socket. Режим instrument не поддерживается.

\subsection{Используемые обозначения}
\textbf{COMMAND\#} - символ решетки заменяет натуральное число (начиная от нуля).  \\
\textbf{<argument>} - угловые скобки - аргументы комманд. \\
\textbf{CMD:[SUBCMD]} - квадратные скобки - необязательная часть команды, необязательный аргумент.

В тексте используются кодовые вставки:
\begin{gverb}
*IDN?                       % Командный запрос  
> RADIOLINE,XXX,XXX,XXX     % Ответ обозначается символом '>'.
                            % - однострочный комментарий.
\end{gverb}

\subsection{О единицах измерения расстояния.}
Команды протокола работают с несколькими разными типами единиц измерения расстояния. 

Оборот - оборот вала двигателя. Входной оборот системы вал-редуктор. \\
Импульс - дискрет обратной связи энкодера сервопривода. Существует постоянное соотношение количества импульсов к количеству оборотов. \\
Юнит(unit) - естественная единица, устанавлимая исходя из требований системы (обычно, сантиметр для линейных осей и градус для поворотных).

\emph{* Количество импульсов в юните для оси может быть \\запрошено командой "AXIS\#:SETTINGS:RATIO?".}

\subsection{О единицах измерения ускорения (времени разгона).}
Ускорения задаются как количество миллисекунд требуемых для разгона двигателя до номинального рабочего режима. Обратите внимание, что ускорение будет повышаться при снижении устанавливаемого времени разгона.  

\newpage
\section{Начало работы.}

SCPI протокол допускает работу в автоматическом и в ручном режимах в зависимости от источника комманд управления. В автоматическом режиме источником комманд является управляющее ПО. В ручном режиме комманды вводятся пользователем через терминал ввода-вывода. Функционально эти режимы не отличаются и реализуются через установленое TCP соединение с SCPI портом (по умолчанию 5025) контроллера.

Ручной режим удобен для проверки соединения и отладки комманд управления для последующего использования в автоматическом режиме, либо для выполнения простых комманд при недоступности управляющего ПО. 

Перед началом работы с протоколом необходимо проверить доступность контролера в локальной сети и установить соединение с SCPI портом изделия. Для установки соединения в ручном режиме можно использовать утилиту \emph{putty}(режим: \emph{raw}) или аналоги. 

Посылки SCPI протокола имеют представление ASCII строк, терминированных символом конца строки (LF: $\backslash$n, dec:10, bin:0x0A).

Тестовый запрос идентификатора изделия:
\begin{gverb}
*IDN?
> RADIOLINE,XXX,XXX,XXX
\end{gverb}

Запрос статуса:
\begin{gverb}
SYST:STAT?              % Запрос статуса готовности изделия
> 0                     % Изделие готово к работе
\end{gverb}

Запрос информации от объекта оси.
\begin{gverb}
SYST:AXESTOT?           % Запрос количества осей.
> 3                     % В системе есть оси 0, 1, 2
AXIS2:UPOSition?        % поскольку нумерация осей идёт от нуля
> 0.378123              
\end{gverb}

Установка параметров.
\begin{gverb}
AXIS2:USPD 2            % Установка параметров и команды
                        % не предполагают ответа            
\end{gverb}


\newpage
\input{ru/scpi-section.tex}

\newpage
\input{ru/ncpi-section.tex}

\newpage
\section{Примеры.}
\subsection{Пример скрипта работы с изделием. (python3)}

\begin{lstlisting}[
	basicstyle=\small\ttfamily,%
    language=Python
]
#!/usr/bin/env python3

import sys
import time
import socket
import threading

HOST = '192.168.1.224' # ip address
SCPI_PORT = 5025 
NCPI_PORT = 5026

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
n = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, SCPI_PORT))
n.connect((HOST, NCPI_PORT))

# request identifier
s.send("AXIS0:STAT:IDN?\r\n".encode("utf-8"))
answer = s.recv(1024).decode("utf-8")
print("axis0 idn is {}".format(answer))

# set speed : 1 unit per second
s.send("AXIS0:USPE 1\r\n".encode("utf-8"))

# set acceleration : 2 seconds for acceleration to nominal speed 
s.send("AXIS0:ACCEL 2000\r\n".encode("utf-8"))

# absolute move to coordinate 4u 
print("move to 4u")
s.send("AXIS0:UMOV:ABS 4\r\n".encode("utf-8"))

time.sleep(5)

# absolute move to coordinate 0u
print("move to 0u")
s.send("AXIS0:UMOV:ABS 0\r\n".encode("utf-8"))
\end{lstlisting}

\newpage
\subsection{Пример скрипта работы с изделием c использованием системы уведомлений. (python3)}
\begin{lstlisting}[
	basicstyle=\small\ttfamily,%
    language=Python
]
#!/usr/bin/env python3

import sys
import time
import socket
import threading

HOST = '192.168.1.224' # ip address
SCPI_PORT = 5025 
NCPI_PORT = 5026

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
n = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, SCPI_PORT))
n.connect((HOST, NCPI_PORT))

s.send("AXIS0:STAT:IDN?\r\n".encode("utf-8"))
answer = s.recv(1024).decode("utf-8")
print("axis0 idn is {}".format(answer))

print("enable notification")
n.send("NOT:AXIS0:UPOS SMOOTH, 0.1\r\n".encode("utf-8"))
n.send("NOT:AXIS0:OPSTAT 1\r\n".encode("utf-8"))

cancel = False
def foo():
	n.settimeout(0.5)
	while cancel is False:
		try:
			message = n.recv(1024).decode("utf-8")
		except:
			pass
		sys.stdout.write("notification: {}".format(message)) 

thr = threading.Thread(target=foo)
thr.start()

print("move to 4u")
s.send("AXIS0:UMOV:ABS 4\r\n".encode("utf-8"))

time.sleep(5)

print("move to 0u")
s.send("AXIS0:UMOV:ABS 0\r\n".encode("utf-8"))

time.sleep(5)
cancel = True
\end{lstlisting}



\newpage
\section{Часто встречающиеся проблемы.}
\subsubsection*{Соединение не установлено}	
Убедитесь в доступности блока управления в локальной сети. Проверьте аппаратное подключение. Произведите ping изделия. Убедитесь, что файрвол на вашей машине не блокирует соединение. При необходимости перезапустите блок управления.

\subsubsection*{Изделие не реагирует на команды управления.}	
Проверьте формат и текст команды. Убедитесь, что команда терминирована символом конца строки LF.

\subsubsection*{Изделие отвечает на комманды, но не двигается.}
Проверьте стек ошибок протокола SCPI.
Проверьте статус системы и осей с помощью комманд:
\begin{gverb}
SYST:STAT?
AXIS\#:STAT?          
\end{gverb}
При возникновении ошибок свяжитесь с изготовителем.

\subsubsection*{Ось движется в одну и ту же сторону вне зависимости от заданного направления движения.}
Проверьте работу UNSAFE подмножества команд движения.
Убедитесь, что пределы оси выставлены верно и текущее положение не сбито. При необходимости переопределите ноль/скоректируйте пределы.

\subsubsection*{В режиме непрерывного сканирования не приходит уведомлений о пройденных точках.}
Убедитесь, что ось поддерживает режим непрерывного сканирования. Проверьте правильность монтажа триггерных цепей. Убедитесь в корректности настроек режима сканирования.

\end{document}

